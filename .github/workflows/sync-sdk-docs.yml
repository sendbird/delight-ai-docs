name: Sync SDK docs from delight-ai-agent

on:
  repository_dispatch:
    types: [sync-sdk-docs]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual changes)'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-sdk-docs:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    env:
      BASE_BRANCH: develop
      SYNC_BRANCH_PREFIX: chore/sync-sdk-docs

    steps:
      - name: Checkout delight-ai-docs
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BASE_BRANCH }}
          token: ${{ github.token }}

      - name: Checkout delight-ai-agent
        uses: actions/checkout@v4
        with:
          repository: sendbird/delight-ai-agent
          ref: main
          path: delight-ai-agent
          token: ${{ secrets.SDK_GH_BOT1_TOKEN }}
          fetch-depth: 2                   # need previous commit for diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Detect updated source files in delight-ai-agent
        id: detect-updates
        run: |
          cd delight-ai-agent

          # If there is no previous commit (very first commit / shallow history),
          # fall back to treating all tracked files as "changed".
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            echo "Diffing HEAD~1..HEAD to find changed files..."
            git diff --name-only HEAD~1 HEAD > ../changed_source_files.txt
          else
            echo "No HEAD~1, using all tracked files as changed (initial sync case)..."
            git ls-files > ../changed_source_files.txt
          fi

          cd ..
          echo "Changed source files (from delight-ai-agent):"
          cat changed_source_files.txt || echo "(none)"

          # Count changed md files for summary
          CHANGED_COUNT=$(grep -c '\.md$' changed_source_files.txt 2>/dev/null || echo "0")
          echo "changed_count=${CHANGED_COUNT}" >> $GITHUB_OUTPUT

      - name: Run sync script
        id: sync-files
        env:
          AGENT_REPO_PATH: delight-ai-agent
          DOCS_REPO_PATH: .
          CHANGED_FILES_PATH: changed_source_files.txt
          SYNCED_FILES_PATH: updated_files.txt
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd scripts/sync
          node sync.js

      - name: Commit changes (one commit per changed file)
        id: commit-changes
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "===== ðŸ“ Commit Changes Step Started ====="

          # 1) Safety check
          if [ ! -f updated_files.txt ] || [ ! -s updated_files.txt ]; then
            echo "âš ï¸  No updated files recorded. Skipping commit and PR."
            echo "skip_pr=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ðŸ“„ updated_files.txt exists and is non-empty"
          echo "----- Contents of updated_files.txt (truncated per line to 100 chars) -----"
          while IFS= read -r line; do
            if [ -z "$line" ]; then
              continue
            fi
            truncated=$(echo "$line" | cut -c1-100)
            echo "  â€¢ $truncated"
          done < updated_files.txt
          echo "--------------------------------------------------------------------------"

          # 2) Configure git
          echo "ðŸ”§ Configuring git user"
          git config user.name "docs-sync-bot"
          git config user.email "docs-sync-bot@users.noreply.github.com"

          # 3) Prepare commit tracking file
          > committed_files.txt

          echo "===== ðŸš€ Creating commits ====="
          COUNT=0
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi

            if [ ! -f "$file" ]; then
              echo "âš ï¸  [WARN] Target file missing at commit time, skipping: $file"
              continue
            fi

            echo "âž¡ï¸  Committing: $file"
            git add "$file"
            git commit --allow-empty -m "[Sync] update $file"
            echo "$file" >> committed_files.txt
            COUNT=$((COUNT+1))
          done < updated_files.txt

          echo "===== ðŸ§¹ Cleanup: removing updated_files.txt ====="
          rm -f updated_files.txt

          # 4) Post-commit checks
          if [ ! -s committed_files.txt ]; then
            echo "âš ï¸  No commits were created (all files missing?). Skipping PR."
            echo "skip_pr=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "===== ðŸ“Œ Summary ====="
          echo "Total commits created: $COUNT"
          echo "Committed files (truncated to 100 chars):"
          while IFS= read -r line; do
            truncated=$(echo "$line" | cut -c1-100)
            echo "  â€¢ $truncated"
          done < committed_files.txt

          echo "===== ðŸ—ï¸  Building PR body ====="
          {
            echo "Automated sync from **delight-ai-agent â†’ delight-ai-docs**."
            echo ""
            echo "Updated files:"
            while IFS= read -r file; do
              if [ -n "$file" ]; then
                echo "- \`$file\`"
              fi
            done < committed_files.txt
          } > PR_BODY.md

          echo "PR body written to PR_BODY.md"
          echo "===== âœ… Commit Step Finished Successfully ====="
          echo "skip_pr=false" >> "$GITHUB_OUTPUT"

      - name: Push branch and create PR via API
        id: push-and-pr
        if: steps.commit-changes.outputs.skip_pr == 'false' && github.event.inputs.dry_run != 'true'
        env:
          GITHUB_TOKEN: ${{ github.token }}
          REPO: sendbird/delight-ai-docs
          BASE_BRANCH: ${{ env.BASE_BRANCH }}
          SYNC_BRANCH: ${{ env.SYNC_BRANCH_PREFIX }}-${{ github.run_id }}
        run: |
          set -e

          echo "Pushing branch $SYNC_BRANCH"
          # --force just in case a branch with the same name exists from a previous run
          git push --force origin HEAD:$SYNC_BRANCH

          echo "Creating PR..."
          PR_DATA=$(python - << 'EOF'
          import json, os
          with open("PR_BODY.md", "r", encoding="utf-8") as f:
              body = f.read()
          data = {
              "title": "[SDK] updated from delight-ai-agent",
              "body": body,
              "head": os.environ["SYNC_BRANCH"],
              "base": os.environ["BASE_BRANCH"],
          }
          print(json.dumps(data))
          EOF
          )

          RESPONSE=$(curl -sS -w "%{http_code}" -o pr_response.json \
            -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/pulls" \
            -d "$PR_DATA")

          echo "GitHub API status: $RESPONSE"
          echo "PR API response:"
          cat pr_response.json

          if [ "$RESPONSE" -lt 200 ] || [ "$RESPONSE" -ge 300 ]; then
            echo "Failed to create PR (status $RESPONSE)."
            exit 1
          fi

          PR_NUMBER=$(python - << 'EOF'
          import json
          with open("pr_response.json", "r", encoding="utf-8") as f:
              data = json.load(f)
          print(data.get("number", ""))
          EOF
          )

          if [ -z "$PR_NUMBER" ]; then
            echo "PR number missing in API response."
            exit 1
          fi

          echo "Created PR #$PR_NUMBER"
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Approve pull request via API
        if: steps.push-and-pr.outputs.pr_number != '' && steps.commit-changes.outputs.skip_pr == 'false' && github.event.inputs.dry_run != 'true'
        env:
          APPROVE_TOKEN: ${{ secrets.SDK_GH_BOT2_TOKEN }}
          REPO: sendbird/delight-ai-docs
          PR_NUMBER: ${{ steps.push-and-pr.outputs.pr_number }}
        run: |
          echo "Approving PR #$PR_NUMBER"
          RESP=$(curl -sS -w "%{http_code}" -o approve_response.json \
            -X POST \
            -H "Authorization: Bearer $APPROVE_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/reviews" \
            -d '{"event":"APPROVE"}')

          echo "Approve API status: $RESP"
          echo "Approve API response:"
          cat approve_response.json

      - name: Summary
        if: always()
        run: |
          echo "## Forward Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changed files in public repo:** ${{ steps.detect-updates.outputs.changed_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Comparison:** Normalized content (text only)" >> $GITHUB_STEP_SUMMARY
          echo "- **Conversion:** Claude AI (Markdown â†’ GitBook)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "- **Mode:** Dry Run (no changes made)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.commit-changes.outputs.skip_pr }}" = "true" ]; then
            echo "- **Result:** No files needed sync (content unchanged or not mapped)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **PR Created:** #${{ steps.push-and-pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          fi
