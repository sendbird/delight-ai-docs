name: Sync Back to Private Repos

on:
  push:
    branches:
      - develop
    paths:
      - 'sdk-docs/**/*.md'

  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual changes)'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-back:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout docs repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get changed files info
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.event.after }}"
          else
            BASE_SHA="HEAD~1"
            HEAD_SHA="HEAD"
          fi

          echo "base_sha=${BASE_SHA}" >> $GITHUB_OUTPUT
          echo "head_sha=${HEAD_SHA}" >> $GITHUB_OUTPUT

          CHANGED_COUNT=$(git diff --name-only ${BASE_SHA} ${HEAD_SHA} -- 'sdk-docs/**/*.md' | wc -l | tr -d ' ')
          echo "changed_count=${CHANGED_COUNT}" >> $GITHUB_OUTPUT
          echo "Changed sdk-docs md files: ${CHANGED_COUNT}"

      - name: Run sync-back script
        if: steps.changes.outputs.changed_count != '0'
        env:
          GITHUB_TOKEN: ${{ secrets.SDK_GH_BOT1_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BASE_SHA: ${{ steps.changes.outputs.base_sha }}
          HEAD_SHA: ${{ steps.changes.outputs.head_sha }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          cd scripts/sync-back
          node sync-back.js

      - name: No changes to sync
        if: steps.changes.outputs.changed_count == '0'
        run: echo "No sdk-docs markdown files changed, nothing to sync"

      - name: Summary
        if: always()
        run: |
          echo "## Sync Back Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changed files:** ${{ steps.changes.outputs.changed_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Comparison:** Normalized content (text only)" >> $GITHUB_STEP_SUMMARY
          echo "- **Conversion:** Claude AI (GitBook â†’ Markdown)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "- **Mode:** Dry Run" >> $GITHUB_STEP_SUMMARY
          fi
